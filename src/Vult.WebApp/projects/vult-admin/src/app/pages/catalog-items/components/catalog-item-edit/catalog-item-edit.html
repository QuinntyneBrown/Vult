<!-- Copyright (c) Quinntyne Brown. All Rights Reserved.
     Licensed under the MIT License. See License.txt in the project root for license information. -->
<mat-card class="catalog-item-edit">
  <mat-card-header>
    <mat-icon mat-card-avatar>{{ isCreating() ? 'add_box' : 'edit' }}</mat-icon>
    <mat-card-title>{{ isCreating() ? 'Create Catalog Item' : 'Edit Catalog Item' }}</mat-card-title>
    <mat-card-subtitle>
      {{ isCreating() ? 'Add a new item to your catalog' : 'Modify item details' }}
    </mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    @if (errorMessage()) {
      <div class="catalog-item-edit__error">
        <mat-icon>error</mat-icon>
        {{ errorMessage() }}
      </div>
    }

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="catalog-item-edit__form">
      <mat-form-field appearance="outline" class="catalog-item-edit__field">
        <mat-label>Brand Name</mat-label>
        <input matInput formControlName="brandName" placeholder="Enter brand name">
        <mat-icon matSuffix>label</mat-icon>
        @if (form.get('brandName')?.hasError('maxlength')) {
          <mat-error>Brand name cannot exceed 200 characters</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="catalog-item-edit__field">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" placeholder="Enter description" rows="3"></textarea>
        @if (form.get('description')?.hasError('maxlength')) {
          <mat-error>Description cannot exceed 1000 characters</mat-error>
        }
      </mat-form-field>

      <div class="catalog-item-edit__row">
        <mat-form-field appearance="outline" class="catalog-item-edit__field catalog-item-edit__field--third">
          <mat-label>Size</mat-label>
          <input matInput formControlName="size" placeholder="e.g., M, L, 10">
          @if (form.get('size')?.hasError('maxlength')) {
            <mat-error>Size cannot exceed 50 characters</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="catalog-item-edit__field catalog-item-edit__field--third">
          <mat-label>Gender</mat-label>
          <mat-select formControlName="gender">
            <mat-option [value]="null">-- Select --</mat-option>
            @for (option of genderOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="catalog-item-edit__field catalog-item-edit__field--third">
          <mat-label>Item Type</mat-label>
          <mat-select formControlName="itemType">
            <mat-option [value]="null">-- Select --</mat-option>
            @for (option of itemTypeOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <div class="catalog-item-edit__row">
        <mat-form-field appearance="outline" class="catalog-item-edit__field catalog-item-edit__field--half">
          <mat-label>Estimated MSRP ($)</mat-label>
          <input matInput type="number" formControlName="estimatedMSRP" placeholder="0.00">
          <mat-icon matSuffix>attach_money</mat-icon>
          @if (form.get('estimatedMSRP')?.hasError('min')) {
            <mat-error>Value must be positive</mat-error>
          }
          @if (form.get('estimatedMSRP')?.hasError('max')) {
            <mat-error>Value cannot exceed $100,000</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="catalog-item-edit__field catalog-item-edit__field--half">
          <mat-label>Estimated Resale Value ($)</mat-label>
          <input matInput type="number" formControlName="estimatedResaleValue" placeholder="0.00">
          <mat-icon matSuffix>sell</mat-icon>
          @if (form.get('estimatedResaleValue')?.hasError('min')) {
            <mat-error>Value must be positive</mat-error>
          }
          @if (form.get('estimatedResaleValue')?.hasError('max')) {
            <mat-error>Value cannot exceed $100,000</mat-error>
          }
        </mat-form-field>
      </div>

      @if (isCreating()) {
        <mat-expansion-panel class="catalog-item-edit__images-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>photo_library</mat-icon>
              Images ({{ imagesArray.length }})
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="catalog-item-edit__images">
            @for (imageControl of imagesArray.controls; track $index; let i = $index) {
              <div class="catalog-item-edit__image-item" [formGroupName]="i">
                <div class="catalog-item-edit__image-preview">
                  @if (imageControl.get('imageData')?.value) {
                    <img [src]="'data:image/jpeg;base64,' + imageControl.get('imageData')?.value" alt="Preview">
                  } @else {
                    <div class="catalog-item-edit__image-placeholder">
                      <mat-icon>add_photo_alternate</mat-icon>
                    </div>
                  }
                </div>
                <div class="catalog-item-edit__image-fields">
                  <button mat-stroked-button type="button" class="catalog-item-edit__upload-btn">
                    <input type="file" accept="image/*" (change)="onFileSelect($event, i)" class="catalog-item-edit__file-input">
                    <mat-icon>upload</mat-icon>
                    Choose Image
                  </button>
                  <mat-form-field appearance="outline" class="catalog-item-edit__field">
                    <mat-label>Description</mat-label>
                    <input matInput formControlName="description" placeholder="Image description">
                  </mat-form-field>
                </div>
                <button mat-icon-button color="warn" type="button" (click)="removeImage(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            }

            <button mat-stroked-button type="button" (click)="addImage()" class="catalog-item-edit__add-image-btn">
              <mat-icon>add</mat-icon>
              Add Image
            </button>
          </div>
        </mat-expansion-panel>
      }

      @if (!isCreating() && catalogItem()?.catalogItemImages?.length) {
        <div class="catalog-item-edit__existing-images">
          <h4>Current Images</h4>
          <div class="catalog-item-edit__image-grid">
            @for (image of catalogItem()!.catalogItemImages; track image.catalogItemImageId) {
              <div class="catalog-item-edit__existing-image">
                <img [src]="'data:image/jpeg;base64,' + image.imageData" [alt]="image.description || 'Catalog image'">
              </div>
            }
          </div>
        </div>
      }
    </form>
  </mat-card-content>

  <mat-card-actions align="end">
    <button mat-button (click)="onCancel()" [disabled]="isSaving()" type="button">
      Cancel
    </button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="isSaving()">
      @if (isSaving()) {
        <mat-spinner diameter="20" class="catalog-item-edit__spinner"></mat-spinner>
        Saving...
      } @else {
        <ng-container>
          <mat-icon>save</mat-icon>
          Save
        </ng-container>
      }
    </button>
  </mat-card-actions>
</mat-card>
