<ng-container *ngIf="viewModel$ | async as vm">
  <div class="catalog-list">
    <header class="catalog-list__header">
      <h1 class="catalog-list__title">Products</h1>
      <button mat-raised-button color="primary" (click)="toggleUpload()" type="button">
        <mat-icon>{{ vm.showUpload ? 'expand_less' : 'cloud_upload' }}</mat-icon>
        {{ vm.showUpload ? 'Hide Upload' : 'Upload Photos' }}
      </button>
    </header>

    <ng-container *ngIf="vm.showUpload">
      <div class="catalog-list__upload-section">
        <app-product-images-upload (uploadComplete)="onUploadComplete($event)"></app-product-images-upload>
      </div>
    </ng-container>

    <ng-container *ngIf="vm.errorMessage">
      <mat-card class="catalog-list__error-card">
        <mat-card-content>
          <mat-icon color="warn">error</mat-icon>
          {{ vm.errorMessage }}
        </mat-card-content>
      </mat-card>
    </ng-container>

    <ng-container *ngIf="vm.isLoading">
      <div class="catalog-list__loading">
        <mat-spinner></mat-spinner>
        <p>Loading products...</p>
      </div>
    </ng-container>

    <ng-container *ngIf="!vm.isLoading && vm.products.length > 0">
      <div class="catalog-list__grid">
        <mat-card class="catalog-list__item" *ngFor="let item of vm.products; trackBy: trackByProductId">
          <ng-container *ngIf="item.productImages && item.productImages.length > 0; else noImage">
            <img mat-card-image
                 [src]="'data:image/jpeg;base64,' + item.productImages[0].imageData"
                 [alt]="item.description || 'Product'">
          </ng-container>
          <ng-template #noImage>
            <div class="catalog-list__placeholder">
              <mat-icon>image_not_supported</mat-icon>
              <p>No Image</p>
            </div>
          </ng-template>
          <mat-card-content>
            <mat-card-title>{{ item.brandName || 'Unknown Brand' }}</mat-card-title>
            <mat-card-subtitle>{{ item.description || 'No description' }}</mat-card-subtitle>
            <div class="catalog-list__item-meta">
              <mat-chip *ngIf="item.size">Size: {{ item.size }}</mat-chip>
              <mat-chip *ngIf="item.estimatedResaleValue" color="primary">${{ item.estimatedResaleValue.toFixed(2) }}</mat-chip>
            </div>
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="warn"
                    (click)="deleteProduct(item.productId)"
                    type="button">
              <mat-icon>delete</mat-icon>
              Delete
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </ng-container>

    <ng-container *ngIf="!vm.isLoading && vm.products.length === 0">
      <div class="catalog-list__empty-state">
        <mat-icon class="catalog-list__empty-icon">inventory_2</mat-icon>
        <h2>No products yet</h2>
        <p>Upload photos to get started</p>
        <button mat-raised-button color="primary" (click)="showUploadPanel()" type="button">
          <mat-icon>cloud_upload</mat-icon>
          Upload Photos
        </button>
      </div>
    </ng-container>

    <ng-container *ngIf="!vm.isLoading && vm.products.length > 0">
      <div class="catalog-list__pagination">
        <button mat-raised-button
                (click)="previousPage()"
                [disabled]="vm.pageNumber === 1"
                type="button">
          <mat-icon>chevron_left</mat-icon>
          Previous
        </button>
        <span class="catalog-list__page-info">Page {{ vm.pageNumber }}</span>
        <button mat-raised-button
                (click)="nextPage()"
                [disabled]="vm.products.length < vm.pageSize"
                type="button">
          Next
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </ng-container>
  </div>
</ng-container>
